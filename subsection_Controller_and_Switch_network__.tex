\subsection{Controller and Switch network}

The system controller is based upon the Arduino development platform (Arduino LLC), specifically the Arduino Due, and two bespoke PCBs: a controller board or "shield" and a switch network board (highlighted in figure \ref{STOverview}). The controller shield contains the additional circuitry required for isolating the communication with other components of the system, namely RS232 and trigger-link connections with the current source, TTL with the EEG systems, and SPI connection to the switch networks. Due to the modular nature of the design and the variation of use cases, each connection was separately isolated from the mains supply, Figure \ref{STBlocks}, to ensure correct isolation regardless of experimental setup.

The current source is programmed via RS232 by the controller, with external triggering and zero-phase marker signals transmitted via a trigger-link cable. The external triggering enables the phase of the injected current to be reset upon switching, or shorter injections to be retriggered by an external pulse. 

The pulses controlling the stimulation for use in Triggered-Averaging mode are sent by the Arduino controller, with user programmable width from 1.5 $\mu$s to $>$ 10 S. The time between these pulses is also set by the user with a similar range, but the precise timing is modified by the controller following the suggestions in \cite{Aristovich_2015} to to occur at random time with respect to the phase of the injected current. This is achieved by offsetting the trigger pulse by a random phase with respect to the Zero-Phase Marker received from the Keithley 6221. Alongside this TTL trigger, a simultaneous stimulation pulse with a programmable range of 3 to 18V can be sent for direct electrical stimulation.

Coded reference pulses from the controller are recorded by the EEG system and uses as reference during data processing. Pulses are sent to indicate the start and stop of current injection, the switching of electrode pairs, changing of injected frequency, stimulation triggers, and the out-of-compliance status of the current source. 

The switch networks comprise two individual series of daisy chained ADG714 CMOS switches (Analog Devices, USA), one each for the source and sink connections from the current source. The switch networks themselves can be daisy chained together, thus enabling current injection between any two electrodes from a total of 128. The switchboard is powered via lithium-ion polymer battery, and communicates with the controller through a digitally isolated SPI bus, figure \ref{STBlocks}. The possible time between switching electrode injection pairs ranges from 100 uS to approximately 70 minutes for 128 channels, which is more than sufficient to meet the frame rate requirements all use cases. 